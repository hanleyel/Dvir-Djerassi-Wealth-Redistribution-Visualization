<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100&display=swap" rel="stylesheet">
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="http://cdn.jsdelivr.net/g/filesaver.js"></script>
    <link rel="stylesheet" href="./static/style.css">
    <title>Wealth Inequality</title>
</head>
<body>
<div class="dashboard-title">
    <h1>100% Wealth Tax on All Fortunes Over $100 Million</h1>
    <h4>Wealth inequality in the United States is dramatic.</br>This interactive tool outlines the potential
    consequences of a radical wealth redistribution program.</h4>
</div>
<div class="row">
        <div class="filter-container">
            <div class="filter-card tab-pane" id="filter-1">
                <p><b>Grant Size</b></p>
                <form>
                    <input type="radio" id="grant-fifteen" name="grant-size" value="grant-fifteen">
                    <label for="grant-fifteen">$15,000</label><br>
                    <input type="radio" id="grant-thirty" name="grant-size" value="grant-thirty">
                    <label for="grant-thirty">$30,000</label><br>
                    <input type="radio" id="grant-fifty" name="grant-size" value="grant-fifty">
                    <label for="grant-fifty">$50,000</label>
                </form>
            </div>
            <div class="filter-card tab-pane" id="filter-2">
                <p><b>Rate of Return</b></p>
                <form>
                    <input type="radio" id="return-one" name="return-size" value="return-one">
                    <label for="return-one">1%</label><br>
                    <input type="radio" id="return-three" name="return-size" value="return-three">
                    <label for="return-three">3%</label><br>
                    <input type="radio" id="return-real" name="return-size" value="return-real">
                    <label for="return-real">Real Rate of Return</label>
                </form>
            </div>
<!--            <div class="filter-card tab-pane" id="filter-3">-->
<!--                <p><b>Revenue-Neutral Wealth Tax</b></p>-->
<!--                <p>[TBD]</p>-->
<!--                <div>-->
<!--                </div>-->
<!--            </div>-->
<!--            <div class="filter-card tab-pane" id="filter-5">-->
<!--                <p><b>Wealth Distribution</b></p>-->
<!--                <div>-->
<!--                    <input type="radio" class="tab-pane" id="current-wealth-dist" name="wealth-dist" value="Networth">-->
<!--                    <label for="current-wealth-dist">Current</label><br>-->
<!--                    <input type="radio" id="post-tax-post-transfer" name="wealth-dist" value="Post-Tax and Post-Transfer">-->
<!--                    <label for="post-tax-post-transfer">Post-Tax&Transfer</label><br>-->
<!--                    <input type="radio" id="post-tax" name="wealth-dist" value="Post-Tax">-->
<!--                    <label for="post-tax">Post-Tax</label>-->
<!--                </div>-->
<!--            </div>-->
<!--            <div class="filter-card">-->
<!--                <p>Filter Card</p>-->
<!--            </div>-->
        </div>
        <div class="tabbable">
            <ul class="nav nav-tab" role="tablist">
                <li class="" id="li-tab-0" role="presentation">
                    <a id="ui-tab-0" href="#tab-0" data-target="#tab-0" data-toggle="tab" data-value="">About</a>
                </li>
                <li class="" id="li-tab-1" role="presentation">
                    <a id="ui-tab-1" class="active" href="#tab-1" data-target="#tab-1" data-toggle="tab" data-value="">Wealth Distribution</a>
                </li>
                <li class="" id="li-tab-2" role="presentation">
                    <a id="ui-tab-2" href="#tab-2" data-toggle="tab" data-value="">Racial Wealth Gap</a>
                </li>
                <li class="" id="li-tab-6" role="presentation">
                    <a id="ui-tab-6" href="#tab-6" data-toggle="tab" data-value="">Median Wealth by Race</a>
                </li>
                <li class="" id="li-tab-3" role="presentation">
                    <a id="ui-tab-3" href="#tab-3" data-toggle="tab" data-value="">Top 1% Share Over Time</a>
                </li>
                <li class="" id="li-tab-7" role="presentation">
                    <a id="ui-tab-7" href="#tab-7" data-toggle="tab" data-value="">Descriptive Statistics</a>
                </li>
                <li class="" id="li-tab-4" role="presentation">
                    <a id="ui-tab-4" href="#tab-4" data-toggle="tab" data-value="">Aggregates</a>
                </li>
                <li class="" id="li-tab-5" role="presentation">
                    <a id="ui-tab-5" href="#tab-5" data-toggle="tab" data-value="">Share of Wealth</a>
                </li>
            </ul>
            <div class="tab-content">
<!--                <div><p>This simulated wealth tax would raise {$dollars} in {$year}.</br>-->
<!--                This program would provide a wealth endowment of {$dollars} per person in {$year}.</p></div>-->
                <div id="tab-0" class="tab-pane" data-value="" role="tabpanel" tabindex="-1" aria-hidden="true" aria-labelledby="ui-tab-0">
                    <br>
                    <h3>[Add "About" header here!]</h3>
                    <p>[Add "About" text here!]</p>
                </div>
                <div id="tab-1" class="tab-pane active" data-value="" role="tabpanel" tabindex="-1" aria-hidden="false" aria-labelledby="ui-tab-1">
                    <p></p>
                    <div id="overlay">
                        <div class="filter-card tab-pane" id="filter-4">
                            <p><b>Year</b></p>
                            <div>
                                <label for="years">Choose a year:</label>
                                <select name="years" id="years">
                                    <option value="2019">2019</option>
                                    <option value="2016">2016</option>
                                    <option value="2013">2013</option>
                                    <option value="2010">2010</option>
                                    <option value="2007">2007</option>
                                    <option value="2004">2004</option>
                                    <option value="2001">2001</option>
                                    <option value="1998">1998</option>
                                    <option value="1995">1995</option>
                                    <option value="1992">1992</option>
                                    <option value="1989">1989</option>


                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab-2" class="tab-pane" data-value="" role="tabpanel" tabindex="-1" aria-hidden="true" aria-labelledby="ui-tab-2"><p></p></div>
                <div id="tab-6" class="tab-pane" data-value="" role="tabpanel" tabindex="-1" aria-hidden="true" aria-labelledby="ui-tab-6"><p></p></div>
                <div id="tab-3" class="tab-pane" data-value="" role="tabpanel" tabindex="-1" aria-hidden="true" aria-labelledby="ui-tab-3"><p></p></div>
                <div id="tab-7" class="tab-pane" data-value="" role="tabpanel" tabindex="-1" aria-hidden="true" aria-labelledby="ui-tab-7"><p></p></div>
                <div id="tab-4" class="tab-pane" data-value="" role="tabpanel" tabindex="-1" aria-hidden="true" aria-labelledby="ui-tab-4"><p></p></div>
                <div id="tab-5" class="tab-pane" data-value="" role="tabpanel" tabindex="-1" aria-hidden="true" aria-labelledby="ui-tab-5"><p></p></div>
            </div>
        </div>
</div>
<script>
    $(document).ready(function(){
        console.log('Document loaded')

        // Change which chart shows and which filter cards show on click
        $('.nav-tab li').on('click', function(){
            $('.nav-tab .active').removeClass('active');
            $(this).addClass('active');
            if (this.id === "li-tab-1"){
                $("#filter-1").css('display','block'); // can change to 'display', 'none' to remove filters from a given vis
                $("#filter-2").css('display','block');
                // $("#filter-3").css('display','block');
                $("#filter-4").css('display','block');
                // $("#filter-5").css('display','block');

            }
            else if (this.id === "li-tab-0"){
                $("#filter-1").css('display','block');
                $("#filter-2").css('display','block');
                // $("#filter-3").css('display','none');
                $("#filter-4").css('display','block');
                // $("#filter-5").css('display','block');
            }
            else if ((this.id === "li-tab-2")||(this.id==="li-tab-3")){
                $("#filter-1").css('display','block');
                $("#filter-2").css('display','block');
                // $("#filter-3").css('display','none');
                $("#filter-4").css('display','none');
                // $("#filter-5").css('display','block');
            }
            else if ((this.id === "li-tab-4")||(this.id==="li-tab-5")){
                $("#filter-1").css('display','block');
                $("#filter-2").css('display','block');
                // $("#filter-3").css('display','none');
                $("#filter-4").css('display','none');
                // $("#filter-5").css('display','block');
            }
            else if (this.id === "li-tab-6"){
                $("#filter-1").css('display','block');
                $("#filter-2").css('display','block');
                // $("#filter-3").css('display','none');
                $("#filter-4").css('display','none');
                // $("#filter-5").css('display','block');
            }
            else if (this.id === "li-tab-7"){
                $("#filter-1").css('display','block');
                $("#filter-2").css('display','block');
                // $("#filter-3").css('display','none');
                $("#filter-4").css('display','none');
                // $("#filter-5").css('display','block');
            }
            else{
                $("#filter-1").css('display','block');
                $("#filter-2").css('display','block');
                // $("#filter-3").css('display','none');
                $("#filter-4").css('display','none');
                // $("#filter-5").css('display','block');
            }
        });

        // Load data from Github
        var files = ["https://raw.githubusercontent.com/AsherDvirDjerassi/WealthTax-Redistribution/main/percentiles_df.csv",
        "https://raw.githubusercontent.com/AsherDvirDjerassi/WealthTax-Redistribution/main/2019_scf_w_forbes.csv",
        "https://raw.githubusercontent.com/AsherDvirDjerassi/WealthTax-Redistribution/main/forbes_400.csv",
        "https://raw.githubusercontent.com/AsherDvirDjerassi/WealthTax-Redistribution/main/scf_2019.csv",
        "https://raw.githubusercontent.com/AsherDvirDjerassi/WealthTax-Redistribution/main/scf.csv",
        "https://raw.githubusercontent.com/AsherDvirDjerassi/WealthTax-Redistribution/main/wealth_tax_revenue_df.csv",
        "https://raw.githubusercontent.com/hanleyel/Dvir-Djerassi-Wealth-Redistribution-Visualization/main/csv/descriptive_statistics.csv?token=AFCUSI6QRVOGRAQ2YZZ36V3BAGB2O",
        "https://raw.githubusercontent.com/hanleyel/Dvir-Djerassi-Wealth-Redistribution-Visualization/main/csv/median_wealth_by_race.csv?token=AFCUSI67LWRPDH2CMDSDYN3BAGB4C",
        "https://raw.githubusercontent.com/hanleyel/Dvir-Djerassi-Wealth-Redistribution-Visualization/main/csv/racial_wealth_gap.csv?token=AFCUSI6REWQZPNHMKTQFAX3BAGB7G",
        "https://raw.githubusercontent.com/hanleyel/Dvir-Djerassi-Wealth-Redistribution-Visualization/main/csv/share_of_wealth_taxable_hh.csv?token=AFCUSI27ZBHPZSEHMAJTEFTBAGCBC"]
        var promises = [];
        files.forEach(function(url){
            promises.push(d3.csv(url))
        });
        // The parameter functions here are the names of the datasets
        Promise.all(promises).then(function([percentiles_data,scf_forbes_data, forbes_400_data, scf_2019_data,scf_data,
        wealth_tax_revenue_data,descriptive_statistics_data, median_wealth_by_race_data,racial_wealth_gap_data,
                                            share_of_wealth_taxable_hh_data]){

            // Set constants
            const margin = {top: 10, right: 50, bottom: 30, left: 80}
            // Gets width and height based on div size
            const width = d3.select('.tabbable').node().getBoundingClientRect().width - margin.left - margin.right;
            const height = d3.select('.tabbable').node().getBoundingClientRect().height - margin.top - margin.bottom;

            // parse the date / time
            var parseTime = d3.timeParse("%Y");

            // format the data
            percentiles_data.forEach(function(d) {
                d.Year = parseInt(d.Year);
                d.Year_timeparsed = parseTime(d.Year);
                d.Networth = parseInt(d.Networth);
                d.Percentiles = parseInt(d.Percentiles*100)
            });
            wealth_tax_revenue_data.forEach(function(d){
                d.Year = parseInt(d.Year);
               d.Year_timeparsed = parseTime(d.Year);
            });

            racial_wealth_gap_data.forEach(function(d){
                d.Year = parseInt(d[""]);
                d.Year_timeparsed = parseTime(d.Year);
                d["Racial Wealth Gap - Observed"] = parseFloat(d["Racial Wealth Gap - Observed"]);
                d["Racial Wealth Gap - Simulated Post-Tax"] = parseFloat(d["Racial Wealth Gap - Simulated Post-Tax"]);
                d["Racial Wealth Gap - Simulated Post-Tax & Transfer"] = parseFloat(d["Racial Wealth Gap - Simulated Post-Tax & Transfer"]);
            });

            median_wealth_by_race_data.forEach(function(d){
                d.Year = parseInt(d[""]);
                d.Year_timeparsed = parseTime(d.Year);
                d["Median All - Observed"] = Number(d["Median All - Observed"].replace(/[^0-9.-]+/g,""))
                d["Median All - Simulated Post-Tax"] = Number(d["Median All - Simulated Post-Tax"].replace(/[^0-9.-]+/g,""))
                d['Median White - Simulated Post-Tax & Transfer'] = Number(d["Median White - Simulated Post-Tax & Transfer"].replace(/[^0-9.-]+/g,""))
                d['Median White - Observed'] = Number(d["Median White - Observed"].replace(/[^0-9.-]+/g,""))
                d['Median Black - Simulated Post-Tax & Transfer'] = Number(d["Median Black - Simulated Post-Tax & Transfer"].replace(/[^0-9.-]+/g,""))
                d['Median Black - Observed'] = Number(d["Median Black - Observed"].replace(/[^0-9.-]+/g,""))
            });

            share_of_wealth_taxable_hh_data.forEach(function(d,i){
                d.Year = median_wealth_by_race_data[i].Year;
                d.Year_timeparsed = parseTime(d.Year);
                d['Observed Share of Wealth Garnered by Households Above Tax Threshold'] = Number(d["Observed Share of Wealth Garnered by Households Above Tax Threshold"].replace(/[^0-9.-]+/g,""))
                d['Simulated Share of Wealth Garnered by Households Above Tax Threshold Before Tax in Year t'] = Number(d["Simulated Share of Wealth Garnered by Households Above Tax Threshold Before Tax in Year t"].replace(/[^0-9.-]+/g,""))
                d['Simulated Post-Tax Share of Wealth Garnered by Households Above Tax Threshold'] = Number(d["Simulated Post-Tax Share of Wealth Garnered by Households Above Tax Threshold"].replace(/[^0-9.-]+/g,""))
                d['Simulated Post-Tax and Transfer Share of Wealth Garnered by Households Above Tax Threshold'] = Number(d["Simulated Post-Tax and Transfer Share of Wealth Garnered by Households Above Tax Threshold"].replace(/[^0-9.-]+/g,""))
            })

            // Unique values for scaling axes
            let years = [...new Set(percentiles_data.map(d=>parseTime(d["Year"])))].sort();
            let networth = percentiles_data.map(d=>d["Networth"]).sort();
            let percentiles = percentiles_data.map(d=>d["Percentiles"]).sort();
            let overall_share = Array.from({length:11},(x,i)=>(i/10));
            let observed = racial_wealth_gap_data.map(d=>d['Racial Wealth Gap - Observed']).sort();
            let post_tax = racial_wealth_gap_data.map(d=>d['Racial Wealth Gap - Simulated Post-Tax']).sort();
            let transferred = racial_wealth_gap_data.map(d=>d['Racial Wealth Gap - Simulated Post-Tax & Transfer']).sort();
            let median_observed = median_wealth_by_race_data.map(d=>d['Median All - Observed']).sort();
            let median_white = median_wealth_by_race_data.map(d=>d['Median White - Observed']).sort();
            let wealth_garnered = share_of_wealth_taxable_hh_data.map(d=>d['Observed Share of Wealth Garnered by Households Above Tax Threshold']).sort();

            // Append tooltip div to body
            let tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .text('tooltip');

            // Append SVGs to tab-content to draw charts
            d3.select("#tab-1").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")")
                .attr("id", "svg-1")
                .attr("class","fullScreen");
            d3.select("#tab-2").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")")
                .attr("id", "svg-2");
            d3.select("#tab-3").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")")
                .attr("id", "svg-3");
            d3.select("#tab-6").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")")
                .attr("id", "svg-6");

            // // Append chart export button to body
            // let exportButton = d3.select(".tab-content").append("button")
            //     .attr("id", "saveButton")
            //     .attr("class", "btn btn-secondary")
            //     .text("Export as PNG");

            // Functions to draw and update axes
            function updateXAxis(data, svg_id, parse_time){
                var x = d3.scaleLinear().domain([Number(d3.min(data)),Number(d3.max(data))]).range([0,width]);
                if (parse_time===true){
                    d3.select(svg_id).append("g").attr("transform", "translate(0, "+height+")").call(d3.axisBottom(x).tickFormat(d3.timeFormat("%Y")))}
                else{
                    d3.select(svg_id).append("g").attr("transform", "translate(0, "+height+")").call(d3.axisBottom(x))}
                return x
            }

            function updateYAxis(data, svg_id){
                if(d3.min(data)<1){
                    var y = d3.scaleLinear().domain([(d3.min(data)*.95),(d3.max(data)*1)]).range([height,0]);
                } else {
                    var y = d3.scaleLinear().domain([0, (d3.max(data) * 1.1)]).range([height, 0]);
                }
                d3.select(svg_id).append("g").attr("transform", "translate(0, 0)").call(d3.axisLeft(y));
                return y
            }

            //Functions to draw charts
            // Function to draw line charts
            function drawLineChart(data,
                                   svg,
                                   draw_line_only,
                                   x_axis_var=years,
                                   y_axis_var=networth,
                                   x_axis_val="Year",
                                   y_axis_val="Networth",
                                   filter_var="Percentiles",
                                   filter_value=9,
                                   parse_time=false, area_chart=false){


                var x = updateXAxis(x_axis_var, svg, parse_time);
                var y = updateYAxis(y_axis_var, svg, parse_time);

                // Define the area under the line
                // define the area
                var area = d3.area()
                    .x(function (d) {
                        return x(d[x_axis_val]);
                    })
                    .y0(height)
                    .y1(function (d) {
                        return y(d[y_axis_val]);
                    });

                // Add the line
                d3.select(svg).append("path")
                    .datum(data.filter(function(d) {
                            if (filter_var != null) {
                                return d[filter_var] === filter_value
                            } else return d
                        }
                        )) // example group
                    .attr("fill", "none")
                    .attr("stroke", "#3da4ab")
                    .attr("stroke-width", 1.5)
                    .attr("d", d3.line()
                        .x(function(d) {
                            console.log(d);
                            return x(d[x_axis_val])})
                        .y(function(d) {
                            return y(d[y_axis_val])})
                    )
                    .attr("class",'linechart '+y_axis_val.replaceAll(" ","-").toString());

                // Add invisible circles for tooltip (tooltip doesn't work well on path)
                d3.select(svg).selectAll("circle")
                    .data(data.filter(function(d) {
                        return d[filter_var] === filter_value })) // example group
                    .enter().append("circle")
                    .attr("r",5)
                    .attr("cx", function(d){
                        return x(d[x_axis_val])})
                    .attr("cy", function(d){
                        return y(d[y_axis_val])})
                    .attr("class","linechart")
                    .style("fill","none")
                    .style("stroke","none")
                    .style("pointer-events","all")
                    .on("mouseover", function(event, d) {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        tooltip.html(d[y_axis_val])
                            .style("left", (event.pageX) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });

                if (area_chart === true){
                    d3.select(svg).selectAll("path")
                        .datum(data.filter(function(d) {
                            return d[filter_var] === filter_value })) // example group
                        .attr("class", "area linechart")
                        .attr("d", area);
                }


            }

            // Function to remove line chart
            function removeLineChart(){
                d3.selectAll(".linechart").remove();
            }

            // Function to draw ski slope chart
            function drawSkislopeChart(){
                console.log('ski slope chart')
            }

            // Function to draw tables
            function drawTable(data, svg, table_id, columns, filter_var, filter_value){
                var table = d3.select(svg).append('table').attr("class","table-bordered table-hover table-light")
                var thead = table.append('thead')
                var	tbody = table.append('tbody');

                // append the header row
                thead.append('tr')
                    .selectAll('th')
                    .data(columns).enter()
                    .append('th')
                    .style("text-align","center")
                    .style("word-break","word")
                    .style("padding", "5px")
                    .style("padding-left","10px")
                    .style("padding-right","10px")
                    .style("border-bottom", "1px solid black")
                    // .style('background-color','#0e9aa7')
                    // .style('color',"white")
                    .html(function (column) {
                        if(!(column.includes("$"))) {
                            var split_column = column.split('.')
                            if (split_column.length >2){
                                split_column.splice(2,0,'<br>')
                            } if (split_column.length > 5){
                                split_column.splice(5,0,'<br>')
                            } if (split_column.length > 8){
                                split_column.splice(8,0,'<br>')
                            }
                            column = split_column.join(' ')
                        }
                        return column
                    });

                // create a row for each object in the data
                var rows = tbody.selectAll('tr')
                    .data(data.filter(function(d) { return d[filter_var] === filter_value }))
                    .enter()
                    .append('tr');

                // create a cell in each row for each column
                var cells = rows.selectAll('td')
                    .data(function (row) {
                        return columns.map(function (column) {
                            return {column: column, value: row[column]};
                        });
                    })
                    .enter()
                    .append('td')
                    .style('padding','5px')
                    .style('padding-left',"10px")
                    .style('padding-right','10px')
                    .html(function (d) {
                        if (!(d.value.toString().includes("$"))) {
                            if (parseFloat(d.value) < 1) {
                                return parseFloat(d.value).toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            } else {
                                if (d.value >= 1000000000) {
                                    return (d.value / 1000000000).toFixed(1).replace(/\.0$/, '').replace(/\B(?=(\d{3})+(?!\d))/g, ",") + 'B';
                                }
                                if (d.value >= 1000000) {
                                    return (d.value / 1000000).toFixed(1).replace(/\.0$/, '').replace(/\B(?=(\d{3})+(?!\d))/g, ",") + 'M';
                                }
                                return parseInt(d.value);
                            }
                        } else{
                            return d.value.toString();
                        }
                    }
            );


                return table;
            }

            // Function to export selected image on export button click
            function exportImage(image_id){
                console.log('Export image');
                d3.select('#saveButton').on('click', function(){
                    console.log('saveButton click');
                    let svgString = getSVGString(document.getElementById(image_id));
                    console.log(svgString);
                    var blob = new Blob([svgString], {type:"image/svg+xml"});
                    saveAs(blob, 'testfile');
                    // console.log(svgString);
                    // svgString2Image(svgString, 2*width, 2*height, 'png'); // passes Blob and filesize String to the callback

                    // function save(dataBlob, filesize){
                        // console.log('saving');
                        // console.log(dataBlob);
                        // saveAs(dataBlob, 'D3 vis exported to PNG.png'); // FileSaver.js function
                    // }
                });
            }

            // getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
            function getSVGString( svgNode ) {
                // svgNode.setAttribute('xlink', 'http://www.w3.org/2000/xlink');
                var cssStyleText = getCSSStyles( svgNode );
                // appendCSS( cssStyleText, svgNode );

                var serializer = new XMLSerializer();
                // var svgString = serializer.serializeToString(svgNode);
                // svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
                // svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix

                var head = 'svg title="graph" version="1.1" xmlns="http://www.w3.org/2000/svg">'

                var svgString = head+'<style>'+cssStyleText+'</style>'+svgNode+'</svg>'
                console.log(svgString);
                return svgString;

                function getCSSStyles( parentElement ) {
                    var selectorTextArr = [];

                    // Add Parent element Id and Classes to the list
                    selectorTextArr.push( '#'+parentElement.id );
                    for (var c = 0; c < parentElement.classList.length; c++)
                        if ( !contains('.'+parentElement.classList[c], selectorTextArr) )
                            selectorTextArr.push( '.'+parentElement.classList[c] );

                    // Add Children element Ids and Classes to the list
                    var nodes = parentElement.getElementsByTagName("*");
                    for (var i = 0; i < nodes.length; i++) {
                        var id = nodes[i].id;
                        if ( !contains('#'+id, selectorTextArr) )
                            selectorTextArr.push( '#'+id );

                        var classes = nodes[i].classList;
                        for (var c = 0; c < classes.length; c++)
                            if ( !contains('.'+classes[c], selectorTextArr) )
                                selectorTextArr.push( '.'+classes[c] );
                    }

                    // Extract CSS Rules
                    var extractedCSSText = "";
                    for (var i = 0; i < document.styleSheets.length; i++) {
                        var s = document.styleSheets[i];

                        try {
                            if(!s.cssRules) continue;
                        } catch( e ) {
                            if(e.name !== 'SecurityError') throw e; // for Firefox
                            continue;
                        }

                        var cssRules = s.cssRules;
                        for (var r = 0; r < cssRules.length; r++) {
                            if ( contains( cssRules[r].selectorText, selectorTextArr ) )
                                extractedCSSText += cssRules[r].cssText;
                        }
                    }


                    return extractedCSSText;

                    function contains(str,arr) {
                        return arr.indexOf( str ) === -1 ? false : true;
                    }

                }

                function appendCSS( cssText, element ) {
                    var styleElement = document.createElement("style");
                    styleElement.setAttribute("type","text/css");
                    styleElement.innerHTML = cssText;
                    var refNode = element.hasChildNodes() ? element.children[0] : null;
                    element.insertBefore( styleElement, refNode );

                }

            }


            // function svgString2Image( svgString, width, height, format) {
                // var svg_data = document.getElementById("svg-1").innerHTML
                // var head = '<svg title="graph" version="1.1" xmlns="http://www.w3.org/2000/svg">'
                // var style = '<style></style>'
                // var full_svg = head+style+svg_data+'</svg>'
                // var blob = new Blob([full_svg], {type:"image/svg+xml"});
                // saveAs(blob, 'test.svg');

                //var format = format ? format : 'png';

                // var imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL
                // var imgsrc = svgString;

                // var blob = new Blob([svgString], {type:"image/svg+xml"});
                // var canvas = document.createElement("canvas");
                // var context = canvas.getContext("2d");

                // canvas.width = width;
                // canvas.height = height;

                // canvas.toBlob(function(){
                //     var blob = new Blob([svgString], {type:"image/svg+xml"});
                //     console.log(svgString);
                    // console.log(blob);
                    // var filesize = Math.round( blob.length/1024 ) + ' KB';
                    // // if ( callback ) callback( blob, filesize );
                    //
                    // var newImg = document.createElement('img'),
                    //     url=URL.createObjectURL(blob);
                    //
                    // newImg.onload=function() {
                    //     URL.revokeObjectURL(url);
                    // };
                    // newImg.src=url;
                    // document.body.appendChild(newImg);

                    // saveAs(blob, 'testfile');
                // });

                // canvas.toBlob( function(blob) {
                //     var filesize = Math.round( blob.length/1024 ) + ' KB';
                //     if ( callback ) callback( blob, filesize );
                // });


                // var image = new Image();
                // // console.log(image);
                // // console.log(svgString);
                // image.onload = function() {
                //     console.log('image load');
                //     context.clearRect ( 0, 0, width, height );
                //     context.drawImage(image, 0, 0, width, height);
                //
                //     canvas.toBlob( function(blob) {
                //         var filesize = Math.round( blob.length/1024 ) + ' KB';
                //         if ( callback ) callback( blob, filesize );
                //     });
                //
                //
                // };
                //
                // image.src = imgsrc;
            // }

            function save_as_svg(){
                var svg_data = document.getElementById("svg-1").innerHTML
                var head = 'svg title="graph" version="1.1" xmlns="http://www.w3.org/2000/svg">'
                var style = '<style></style>'
                var full_svg = head+style+svg_data+"</svg>"
                var blob = new Blob([full_svg], {type:"image/svg+xml"});
                saveAs(blob, 'test.svg');
            }



            // Run Code
            // Get radio button values for filtering data

            //Grant Size
            let grant_size = d3.selectAll("input[name='grant-size']").on("click", function(){
                console.log(this.value);
                return this.value;
            });

            // Return Size
            let return_size = d3.selectAll("input[name='return-size']").on("click", function(){
                console.log(this.value);
                return this.value;
            });

            // Year
            let year = d3.selectAll("select[name='years']").on("change", function(){
                year = parseInt(this.value);
                console.log(year);
                removeLineChart(svg="#svg-1");
                console.log(year);
                drawLineChart(
                    data=percentiles_data,
                    svg="#svg-1",
                    draw_line_only=false,
                    x_axis_var=percentiles,
                    y_axis_var=networth,
                    x_axis_val="Percentiles",
                    y_axis_val="Networth",
                    filter_var="Year",
                    filter_value=year,
                    parse_time=false,
                    area_chart=true);
                return this.value;
            });

            // // Wealth Distribution
            // let wealth_dist = d3.selectAll("input[name='wealth-dist'").on("click",function(){
            //
            //     wealth_dist = this.value;
            //
            //     var wealth_dist_top1 = "Pre.Tax.Top.1..Share"
            //     var wealth_dist_top10 = "Pre.Tax.Top.10..Share"
            //
            //     if (wealth_dist === "Post-Tax and Post-Transfer"){
            //         wealth_dist_top1 = "Post.Tax.and.Post.Transfer.Top.1..Share"
            //         wealth_dist_top10 = "Post.Tax.and.Post.Transfer.Top.10..Share"
            //     } else if (wealth_dist === "Post-Tax"){
            //         wealth_dist_top1 = "Post.Tax.Top.1..Share"
            //         wealth_dist_top10 = "Post.Tax.Top.10..Share"
            //     } else {
            //         wealth_dist_top1 = "Pre.Tax.Top.1..Share"
            //         wealth_dist_top10 = "Pre.Tax.Top.10..Share"
            //     }
            //
            //     removeLineChart();
            //     drawLineChart(
            //         data=percentiles_data,
            //         svg="#svg-1",
            //         draw_line_only=false,
            //         x_axis_var=percentiles,
            //         y_axis_var=networth,
            //         x_axis_val="Percentiles",
            //         y_axis_val=wealth_dist,
            //         filter_var="Year",
            //         filter_value=2019,
            //         parse_time=false,
            //         area_chart=true);
            //
            //     drawLineChart(
            //         data=racial_wealth_gap_data,
            //         svg="#svg-2",
            //         draw_line_only=false,
            //         x_axis_var='',
            //         y_axis_var='Racial Wealth Gap - Observed',
            //         x_axis_val='',
            //         y_axis_val='Racial Wealth Gap - Observed',
            //         filter_var=null,
            //         filter_value=null,
            //         parse_time=true);
            //
            //     drawLineChart(
            //         data=wealth_tax_revenue_data,
            //         svg="#svg-3",
            //         draw_line_only=false,
            //         x_axis_var=years,
            //         y_axis_var=overall_share,
            //         x_axis_val="Year_timeparsed",
            //         y_axis_val=wealth_dist_top10,
            //         filter_var=null,
            //         filter_value=null,
            //         parse_time=true);
            // })

            // Percentile
            let percentile_selection = d3.selectAll("input[name='percentile-selection'").on("click",function(){
                console.log(this.value);
                return this.value;
            })

            // DRAW CHARTS

            // Ski slope chart
            drawLineChart(
                data=percentiles_data,
                svg="#svg-1",
                draw_line_only=false,
                x_axis_var=percentiles,
                y_axis_var=networth,
                x_axis_val="Percentiles",
                y_axis_val="Networth",
                filter_var="Year",
                filter_value=2019,
                parse_time=false,
                area_chart=true);

            // Racial wealth gap data chart
            drawLineChart(
                data=racial_wealth_gap_data,
                svg="#svg-2",
                draw_line_only=false,
                x_axis_var=years,
                y_axis_var=observed,
                x_axis_val="Year_timeparsed",
                y_axis_val="Racial Wealth Gap - Observed",
                filter_var=null,
                filter_value=null,
                parse_time=true);

            drawLineChart(
                data=racial_wealth_gap_data,
                svg="#svg-2",
                draw_line_only=true,
                x_axis_var=years,
                y_axis_var=observed,
                x_axis_val="Year_timeparsed",
                y_axis_val="Racial Wealth Gap - Simulated Post-Tax",
                filter_var=null,
                filter_value=null,
                parse_time=true);

            drawLineChart(
                data=racial_wealth_gap_data,
                svg="#svg-2",
                draw_line_only=true,
                x_axis_var=years,
                y_axis_var=observed,
                x_axis_val="Year_timeparsed",
                y_axis_val="Racial Wealth Gap - Simulated Post-Tax & Transfer",
                filter_var=null,
                filter_value=null,
                parse_time=true);
            // End of Racial Wealth Gap data chart

            // Median wealth by race chart
            drawLineChart(
                data=median_wealth_by_race_data,
                svg="#svg-6",
                draw_line_only=false,
                x_axis_var=years,
                y_axis_var=median_white,
                x_axis_val="Year_timeparsed",
                y_axis_val="Median White - Observed",
                filter_var=null,
                filter_value=null,
                parse_time=true);

            drawLineChart(
                data=median_wealth_by_race_data,
                svg="#svg-6",
                draw_line_only=false,
                x_axis_var=years,
                y_axis_var=median_white,
                x_axis_val="Year_timeparsed",
                y_axis_val="Median White - Simulated Post-Tax & Transfer",
                filter_var=null,
                filter_value=null,
                parse_time=true);

            drawLineChart(
                data=median_wealth_by_race_data,
                svg="#svg-6",
                draw_line_only=false,
                x_axis_var=years,
                y_axis_var=median_white,
                x_axis_val="Year_timeparsed",
                y_axis_val="Median Black - Observed",
                filter_var=null,
                filter_value=null,
                parse_time=true);

            drawLineChart(
                data=median_wealth_by_race_data,
                svg="#svg-6",
                draw_line_only=false,
                x_axis_var=years,
                y_axis_var=median_white,
                x_axis_val="Year_timeparsed",
                y_axis_val="Median Black - Simulated Post-Tax & Transfer",
                filter_var=null,
                filter_value=null,
                parse_time=true);
            // End of Median wealth by race chart

            // Top 1% chart
            drawLineChart(
                data=share_of_wealth_taxable_hh_data,
                svg="#svg-3",
                draw_line_only=false,
                x_axis_var=years,
                y_axis_var=wealth_garnered,
                x_axis_val="Year_timeparsed",
                y_axis_val="Observed Share of Wealth Garnered by Households Above Tax Threshold",
                filter_var=null,
                filter_value=null,
                parse_time=true);

            drawLineChart(
                data=share_of_wealth_taxable_hh_data,
                svg="#svg-3",
                draw_line_only=false,
                x_axis_var=years,
                y_axis_var=wealth_garnered,
                x_axis_val="Year_timeparsed",
                y_axis_val="Simulated Share of Wealth Garnered by Households Above Tax Threshold Before Tax in Year t",
                filter_var=null,
                filter_value=null,
                parse_time=true);

            drawLineChart(
                data=share_of_wealth_taxable_hh_data,
                svg="#svg-3",
                draw_line_only=false,
                x_axis_var=years,
                y_axis_var=wealth_garnered,
                x_axis_val="Year_timeparsed",
                y_axis_val="Simulated Post-Tax Share of Wealth Garnered by Households Above Tax Threshold",
                filter_var=null,
                filter_value=null,
                parse_time=true);

            drawLineChart(
                data=share_of_wealth_taxable_hh_data,
                svg="#svg-3",
                draw_line_only=false,
                x_axis_var=years,
                y_axis_var=wealth_garnered,
                x_axis_val="Year_timeparsed",
                y_axis_val="Simulated Post-Tax and Transfer Share of Wealth Garnered by Households Above Tax Threshold",
                filter_var=null,
                filter_value=null,
                parse_time=true);
            //End of top 1% chart

            drawTable(
                data=descriptive_statistics_data,
                svg="#tab-7",
                table_id="descriptives-table",
                columns=["", "US Population", "Cost per Birth", "Children Born", "Total Endowment Program Cost", "Tax Rate"],
                filter_var="Cost per Birth",
                filter_value="$17,482");

            drawTable(
                data=wealth_tax_revenue_data,
                svg="#tab-4",
                table_id="aggregate-table",
                columns=["Year","Taxable.Wealth","Wealth.Tax.Revenue","Total.Net.Private.Wealth",
                    "Wealth.Endowment.Per.Person"],
                filter_var="Tax.Rate",
                filter_value="1");

            drawTable(
                data=wealth_tax_revenue_data,
                svg="#tab-5",
                table_id="aggregate-table",
                columns=["Year", "Pre.Tax.Top.1..Share", "Post.Tax.Top.1..Share",
                "Post.Tax.and.Post.Transfer.Top.1..Share"],
                filter_var="Tax.Rate",
                filter_value="1");

            exportImage("svg-1");
            // save_as_svg();

        }); //end data

    });
</script>
</body>
</html>